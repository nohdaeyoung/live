### 2026-02-24 Session Notes
- 시간(로컬): 2026-02-24 10:01 KST

## 주요 활동 (요약)

### 사미사 Stock 포트폴리오 신규 구축 완료
- **GitHub 리포 생성:** `gh repo create stock-ticker --private` 로 터미널에서 직접 생성·push
- **Vercel 배포:** https://stock-ticker-eosin.vercel.app/
- **API 변천사:**
  - Alpha Vantage → Yahoo Finance(429) → 네이버 금융 API(한국) + Twelve Data(미국)로 최종 확정
  - 한국: 네이버 `basic` + `integration` API 병렬 호출 (API 키 불필요)
  - 미국: Twelve Data API (키: `fddd089c41864f91bf21f3cc9fda7b7e`, 분당 8크레딧 제한)
  - Alpha Vantage 키도 보유: `CPCXUW04XJXXHRBR` (미국 주식용이나 느림)
- **Vercel 환경변수:** `TWELVE_DATA_KEY`, `ALPHA_VANTAGE_KEY` 등록 완료

### 사미사 Stock 포트폴리오 주요 기능
- 🇰🇷 한국 탭: 15개 ETF/종목, 30초 자동 갱신
- 🇺🇸 미국 탭: 13개 종목 (배치1 8개 즉시 + 배치2 5개 61초 후), 30분 자동 갱신
- 데이터: 현재가·등락폭·등락률·전일종가·시가·고가·저가·PER·EPS·PBR
- 프론트 캐시: 오류 시 이전 데이터 유지 (usCache)
- 시간대별 자동 탭 전환 (KST 기준):
  - 08:30~15:30 → 🇰🇷 한국 (장중)
  - 15:30~23:00 → 🇰🇷 한국 (종료 후)
  - 23:00~06:00 → 🇺🇸 미국 (장중)
  - 06:00~08:30 → 🇺🇸 미국 (종료 후)

### 한국 15개 종목
맥쿼리인프라(088980), ACE 미국S&P500(360200), KODEX 미국S&P500(379800), KODEX Top10동일가중(395170), TIGER 코리아TOP10(292150), TIGER 리츠부동산인프라(329200), TIGER 2차전지TOP10(364980), TIGER 미국S&P500(360750), TIGER 미국필라델피아반도체나스닥(381180), RISE 200(148020), PLUS 고배당주(161510), RISE 코스피(302450), TIGER 미국테크TOP10 INDXX(381170), KODEX 머니마켓액티브(488770), KODEX 200(069500)

### 미국 13개 종목 (알파벳 순)
AAPL, AMZN, AVGO, CONY, DIS, ETN, F, GOOGL, NKE, NVDA, PLTR, TSLA, VOO

### BIP 사이트 업데이트
- project-board에 "사미사 Stock 포트폴리오" 항목 추가 (완료 → 개발중으로 재변경)
- 빌드 + Firebase 배포 완료 (project-a3e9a)

### MEMORY.md 재구성
- 세션 초기 MEMORY.md가 비어있어 전체 재작성 완료

---
### 10:05 KST 추가

## 뉴스 기능 논의 중
- Alpha Vantage `NEWS_SENTIMENT` API로 미국 주식 뉴스 가능 (키: CPCXUW04XJXXHRBR)
- 한국 주식 뉴스: Alpha Vantage 미지원 → 네이버 금융 RSS 활용 방안 검토 중
- 마스터님께 A(미국만) vs B(한국+미국) 선택 대기 중

---

### 2026-02-24 10:43 KST — Durable memory append
- 사용자 요청(현재 세션): "미국 탭의 뉴스 소스를 미국의 주요 언론사(예: AP, Reuters, NYT, CNN, WSJ 등)로 교체" 요청
- 맥락: 기존 구현은 Alpha Vantage `NEWS_SENTIMENT` (feed[])를 사용하여 미국 주식별 뉴스 목록을 제공함. 사용자는 보다 권위있는(또는 주요 언론사) 소스로 바꾸기를 원함.
- 권장 다음 단계 (체크리스트):
  1. 코드 위치 확인: `vercel-stock-template/public/index.html` 내의 `loadUSNews()` 호출부 및 `api/us-news.js` 서버리스 함수
  2. 서버리스 API 교체안 검토: (a) Alpha Vantage → 주요 언론사 RSS/뉴스 API 수집기 작성, (b) 뉴스 API(NewsAPI.org 등) 사용 시 비용/요금·이용약관 확인, (c) 직접 크롤링/스크래핑은 사이트 약관 위반 위험 있음
  3. 우선 구현 제안: Alpha Vantage 보완용으로 Reuters/AP RSS, NYTimes RSS(일부는 API key 필요), Google News RSS(대체 가능) 중 비용·약관을 고려해 2~3개 소스를 우선 수집하여 통합·중복제거 후 제공
  4. UI/UX: `public/index.html`의 US news 섹션 제목을 "📰 미국 주요 언론 뉴스"로 변경, 각 기사 출처 표시
  5. 캐시: 기존 5분 캐시 전략 유지 권장
- 액션 아이템: 사용자가 어떤 매체(예: AP+Reuters) 우선순위를 원하는지 지정해달라고 요청 예정.

Saved by: 알프레드 (Assistant)

---
### 2026-02-24 14:44 KST — Runtime edits & indices parsing work (new append)
- 작업 개요:
  - `vercel-stock-template/api/indices.js`에 대해 여러 차례 편집·배포(커밋 포함)를 수행하여 Yahoo HTML 파싱의 우선순위를 `data-test="qsp-price"`로 높이고, fin-streamer/스팬 폴백을 유지함.
  - 추가로 Google Finance 스크래핑 보조 로직을 강화하고, 추출값에 대한 허용 범위(sanity ranges)를 도입하여 비정상값을 탐지하면 Google 샘플에서 재탐색(salvage) 하도록 구현함.
- 주요 변경 사항 (커밋 히스토리):
  1. commit 401944c — "fix(indices): prioritize Yahoo qsp-price selector for accurate index values" (qsp-price 우선 매칭 도입)
  2. commit 6459211 — "fix(indices): sanity-range checks and salvage from Google sample for DOW/NASDAQ/S&P" (허용범위 검사 + 구글 샘플 재탐색)
  3. commit c6c82ae — "fix(indices): anchor-based extraction on Yahoo HTML to pick main index value near heading" (앵커 기반 인접 검색 추가)
  4. commit 9f822ae — "fix(indices): anchored salvage extraction from Google sample (search near index name)" (구글 샘플 앵커 탐색 보강)
- 테스트 및 현재 관찰 (배포 후 `/api/indices?debug=1` 호출 결과 요약):
  - KOSPI: 5956.96 ~ 5961.02 (Naver scraping; 안정적)
  - KOSDAQ: 1163.76 ~ 1164.12 (Naver scraping; 안정적)
  - DOW: 60000 혹은 6869.25 등(잘못된 값이 혼재; 실제값 ~48,804.06) — 여전히 파싱 불일치 있음
  - NASDAQ: 60000 혹은 6871.5 등(잘못된 값이 혼재; 실제값 ~22,627.27)
  - S&P500 (SNP): 6,837.75 (추출됨)
  - tdRaw: Twelve Data 호출이 연속적으로 429(크레딧 초과) 또는 오류를 반환함 — Twelve Data 의존도 감소 필요
  - yahooRaw: API 호출 시 401 또는 접근 불가 상태가 보고됨 (HTML 스크래핑으로 폴백 중)
  - googleRaw: Google Finance HTML 샘플은 확보됐으나 샘플 내에서도 적합한 숫자를 찾는 것이 항상 안정적이지 않음
- 원인 분석:
  - Google/Yahoo 페이지는 여러 숫자(선물, 위젯, 지역별 포매팅 등)를 포함하고 있어 단순한 "첫 번째 큰 숫자" 방식으로는 오탐이 발생함.
  - qsp-price/data-test는 우선적으로 시도되지만, 페이지 버전/로케일/동적 로딩 차이로 인해 항상 존재하지 않음.
  - Twelve Data는 쿼터 초과로 안정적 대체가 불가능한 상태.
- 다음 권장 작업(우선순위):
  1. Yahoo 페이지에서 qsp-price(혹은 fin-streamer[data-field="regularMarketPrice"])가 실제 메인 지수값을 나타내는지 더 면밀히 확인하고, 필요한 경우 더 구체적인 DOM 선택자(또는 cheerio 기반 DOM 파싱)로 전환.
  2. Google Finance 파서에서 인덱스명 근처의 스크립트(임베디드 JSON) 또는 더 구체적 CSS 셀렉터를 사용하여 값 추출을 시도.
  3. 교차검증 적용: Yahoo와 Google에서 동일(또는 근접) 값이 나올 때 채택; 둘 다 없으면 null로 표기.
  4. Twelve Data 쿼터 문제 해결(요금제 업그레이드 또는 프로브 수 제한) 검토.
  5. UI에 "임시값/데이터 검증중" 표시 추가(사용자 혼란 방지).
- 다음 액션(제가 진행 가능한 작업):
  - Yahoo DOM 추가 분석 및 파서 보강(지금도 진행 중) — 필요 시 cheerio로 구조적 파싱 전환.
  - Google 샘플에서 임베디드 JSON/정확 셀렉터 찾아서 교차검증 로직 구현.

Saved by: 알프레드 (Assistant)

---
### 2026-02-24 15:37 KST — UI 복구 및 로딩 문제 수정 (new append)
- 작업 요약:
  - 사용자 요청으로 미국 패널(#panel-us)을 "예전에 잘 나오던 상태"로 되돌렸음 (TradingView 임베드 제거).
  - public/index.html을 이전 커밋(4fa000ae) 기준으로 복원하고 커밋 및 푸시함 (커밋: "revert(ui): restore previous working US panel layout (pre-TradingView embed)").
  - 복원 후에도 미국 탭이 계속 "로딩 중" 상태여서 추가 점검함. 원인: applyUS(quotes) 함수가 에러 객체를 usCache에 저장하지 않아 usCache가 비어 있었음.
  - 즉시 수정: applyUS(quotes)를 변경하여 에러 객체 포함 모든 응답 항목을 usCache에 저장하도록 수정함 (commit: "fix(ui): populate usCache with API error objects so US panel stops showing perpetual loading (restore)").
  - 변경사항 푸시 완료.
- 기대 효과:
  - 이제 미국 탭은 API가 에러를 반환하더라도 usCache가 비어있지 않으므로 '로딩 중' 스피너가 사라지고 각 행에 에러 메시지 또는 이전 값(있다면)을 표시함.
- 다음 권장 점검:
  1. 사용자가 클라이언트에서 강력 새로고침(Shift/Cmd+R) 후 여전히 로딩이면, `/api/us-quotes?batch=1`의 응답(콘솔 Network → Response)을 복사해 제공해 달라고 요청.
  2. 서버측 로그에서 Twelve Data 폴백이 실제로 Yahoo HTML 스크래핑으로 대체되고 있는지 확인(개발자 도구의 Network 응답과 API의 debug 필드 확인).

Saved by: 알프레드 (Assistant)

---
### 2026-02-24 16:48 KST — Session append
- 작업 및 상태 요약:
  - 사용자 지시로 `api/us-quotes`의 데이터 소스 우선순위를 네이버 모바일(worldstock) 페이지에서 종가(previousClose)를 추출하도록 여러 차례 수정 및 커밋함.
  - `api/us-quotes.js`에 Naver 모바일 우선(fetchNaverMobile) 로직을 추가했고, 이후 사용자의 요청으로 "네이버만 사용" 모드(폴백 제거)를 적용하여 커밋함 (commit: "feat(us-quotes): use Naver mobile pages only for US previousClose (per user request)").
  - 캐시 문제를 완화하기 위해 `?force=1` 파라미터로 /tmp 캐시 파일을 삭제해 캐시된 에러 응답을 무효화하도록 핫픽스 추가(커밋: "chore(us-quotes): add force=1 to delete cache file and bypass cached error responses").
  - 그러나 실제 배포 환경에서는 Vercel의 배포·빌드/무료 일일 배포 한도(`api-deployments-free-per-day`)에 걸려 재배포가 차단되었고, 기존에 TwelveData가 반환한 "API credits exhausted" 응답이 edge/CDN 또는 이전 인스턴스에서 계속 서빙되어 실데이터가 아직 유입되지 않음.
  - 사용자가 수동으로 Vercel에서 Redeploy를 시도했고, 재배포 중에도 Vercel에서 "Resource is limited - try again in 7 hours (api-deployments-free-per-day)" 메시지가 뜨는 상황을 확인함.
  - 사용자의 요청에 따라 현재 작업을 중단(정지)하고 7시간 후에 재시도하기로 합의했고, 제가 7시간 뒤 자동으로 `/api/us-quotes?batch=1&fresh=1`를 호출해 결과를 보고하기로 함.

- 추가 변경(프론트):
  - public/index.html의 미국 패널을 전일종가(previousClose) 우선 표기로 변경함(테이블 헤더, 모바일 카드, 등락폭/등락률 계산을 previousClose 기준으로 변경). 해당 UI 변경은 커밋됨(커밋 메시지: "feat(ui): show previousClose (종가) for US panel; hide real-time columns and label as 종가" 및 후속 커밋으로 등락폭/등락률을 previousClose 기준으로 계산하도록 보강).

- 운영·디버그:
  - 현재 `/api/us-quotes`의 최신 호출(재배포 시도 포함)에서 반환되는 실제 응답은 TwelveData의 쿼터 초과 에러 메시지(심볼별 error objects)이며, force 파라미터와 빈 커밋 재배포에도 바로 바뀌지 않음(아마도 Vercel edge cache 또는 배포 한도 영향).
  - m.stock.naver.com 에 대해 서버-사이드 단순 GET으로는 일부 종목의 종가를 파싱하기 어렵다는 점을 확인(렌더링/차단/간소화된 HTML 응답 관찰).

- 다음 계획(약속):
  1. 7시간 후에 자동 재시도: `/api/us-quotes?batch=1&fresh=1` 호출 후 결과를 보고.
  2. 재배포 제한 해제 후에도 문제가 지속되면 debug=1 모드(각 심볼별 시도한 소스·스니펫 포함)를 추가해 배포하고 문제 원인 심층 조사.
  3. Naver 모바일에서 안정적 previousClose 추출이 불가능할 경우 헤드리스 렌더링(Playwright) 혹은 내부 JSON 엔드포인트 탐색으로 보완할 계획.

Saved by: 알프레드 (Assistant)

---

Saved at: 2026-02-24 16:48 KST — 알프레드
