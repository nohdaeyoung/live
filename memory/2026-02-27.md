# Memory log — 2026-02-27

- 시간: 2026-02-27 08:01 (Asia/Seoul)

## 오늘의 주요 작업/상태 요약

1. Cloudflare R2 통합 완료(서버 측):
   - 이미지 저장을 Supabase Storage에서 Cloudflare R2로 전환함.
   - 서버에 @aws-sdk/client-s3 기반의 R2 클라이언트(r2.ts) 추가.
   - 원본은 서버에서 Sharp로 최적화(JPEG max 2000px, quality 90), 썸네일은 WebP 400px 생성 후 R2에 업로드.
   - .env.local 및 .env.example에 R2 관련 변수 추가(민감 정보는 파일에 적재됨 — 즉시 키 회수/재발급 권장).

2. 로컬 Mac 워처 구현 및 데몬화:
   - watcher.mjs: chokidar로 폴더 감지, sips로 RAW→JPEG 변환(sips -Z 2000 -s format jpeg), 배치 업로드(기본 BATCH_SIZE=5), 임시 파일 삭제.
   - pm2로 photo-watcher 프로세스 등록, pm2 save 및 launchd 자동시작 설정(사용자 sudo로 pm2 startup 실행 필요).
   - 워처 로그 경로: /Users/dyno/.pm2/logs/photo-watcher-out.log, ...-error.log
   - 워처는 변환까지 정상 동작하나 R2 업로드 단계에서 DNS/권한(getaddrinfo ENOTFOUND, Unauthorized, Access Denied) 에러 관찰됨.

3. 카메라 커버 업로드 문제 해결:
   - 원인: cameras 테이블에 cover_photo_url 칼럼 부재로 인한 서버 500 에러(스키마 캐시 문제).
   - 조치: Supabase SQL Editor에서 안전한 ALTER TABLE 실행(ADD COLUMN IF NOT EXISTS cover_photo_url TEXT) — 사용자가 실행함.
   - 이후 서버 API(/api/cameras/cover) 재시도에서 R2 업로드 및 DB 업데이트(cover_photo_url 쓰기) 정상 동작 확인.
   - 프론트(Admin)에서 즉시 반영되지 않던 문제는 클라이언트 로직 미반영 때문으로 판명되어 Admin 페이지 코드 수정(업로드 성공 시 setCameras로 즉시 UI 반영) 및 배포 완료.

4. 레포지토리 및 배포 관련:
   - 여러 커밋 푸시(업로드 개선, R2 전환, watcher 추가 등).
   - 실수로 watcher/node_modules가 큰 커밋에 포함된 상태 — 별도 히스토리 정리 필요(사용자 요청 시 git 필터-브랜치/트리거 제공 예정).
   - Vercel 배포: 사이트 https://photo-gallery-chi-seven.vercel.app 정상 동작.

5. 보안 상태/권고:
   - Cloudflare R2 키와 Supabase service_role 키가 대화 중 일부 파일(.env.local 등)에 노출됨 — 즉시 키 회수(rotate) 권장.
   - R2 토큰은 "Object Read & Write" 권한이어야 하며, Vercel 환경변수로 정확히 설정되어야 함.

6. 운영 체크포인트/로그 이슈
   - 워처 로그에서 반복적으로 발생한 에러: getaddrinfo ENOTFOUND <generated-subdomain>.r2.cloudflarestorage.com — Account ID/endpoint 또는 DNS 설정 불일치 가능성.
   - 로컬 테스트 스크립트(test-r2.js)를 통해 직접 업로드 시 Unauthorized 또는 getaddrinfo 오류를 확인함.

## 사용자 선호/운영 규칙(반복적)
- 한국어로 응답 선호
- 민감 정보(키/토큰)는 채팅에 붙여넣지 않도록 경고했음
- pm2 재시작 시 --update-env 필요(환경변수 업데이트 반영)

## 다음 우선 작업(권장 순서)
1. 노출된 키 즉시 회수(Cloudflare R2, Supabase service_role) 및 새 키 생성
2. Vercel 환경변수 업데이트 후 Redeploy
3. pm2 restart photo-watcher --update-env 및 pm2 save, 로그 확인
4. 레포지토리 대용량 파일(node_modules) 히스토리 정리 및 .gitignore 업데이트
5. 워처의 실패 재시도 로직 및 로그 로테이션 추가

---
소중한 정보(키/토큰)는 이 메모에 포함하지 않았습니다. 필요 시 키 교체 절차와 자동화 스크립트 제공 가능.